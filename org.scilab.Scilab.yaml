app-id: org.scilab.Scilab
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: scilab
#rename-desktop-file: avogadro2.desktop
#rename-desktop-file: molequeue.desktop
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk8
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
  # Molequeue enjoy its life in the menu tray.
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # Allow Avogadro to communicate with Molequeue.
  - --share=network
cleanup:
  - /include
  - /lib/cmake
  - /share/doc
  - "*.la"
  - "*.a"

modules:
  #- shared-modules/glew/glew.json

  #- name: glew
    #no-autogen: true
    #make-args:
      #- GLEW_PREFIX=/app
      #- GLEW_DEST=/app
      #- LIBDIR=/app/lib
      #- CFLAGS.EXTRA:=${CFLAGS} -fPIC
      #- LDFLAGS.EXTRA=${LDFLAGS}
    #make-install-args:
      #-GLEW_PREFIX=/app
      #- GLEW_DEST=/app
      #- LIBDIR=/app/lib
      #- CFLAGS.EXTRA:=${CFLAGS} -fPIC
      #- LDFLAGS.EXTRA=${LDFLAGS}
    #sources:
      #- type: archive
        #url: https://downloads.sourceforge.net/project/glew/glew/2.2.0/glew-2.2.0.tgz
        #sha256: d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1

  - shared-modules/glu/glu-9.json
      
  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.10/hdf5-1.10.5/src/hdf5-1.10.5.tar.bz2
        sha256: 68d6ea8843d2a106ec6a7828564c1689c7a85714a35d8efafa2fee20ca366f44
        
  - name: OCaml
    sources:
      - type: archive
        url: https://github.com/ocaml/ocaml/archive/refs/tags/4.12.0.tar.gz
        sha256: adc07a3995362403f3cb11085a86354de08e5a7f9eb3c09be7bbcc38a3a26744

  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk8/install.sh
      - mkdir -p /app/lib/java-8-openjdk
      - cp -r /usr/lib/sdk/openjdk8/jvm/java-8-openjdk/* /app/lib/java-8-openjdk

  - name: ant
    buildsystem: simple
    cleanup:
      - '*.bat'
      - '*.cmd'
    sources:
      - type: file
        url: http://archive.apache.org/dist/ant/binaries/apache-ant-1.10.8-bin.tar.gz
        dest-filename: apache-ant-bin.tar.gz
        sha512: 4d80dc6ba23eeec7769085ddb00261b7480b596b56c6e69aa221391acbfb7338eb5855179c88222c8021095ef1f64f43caf2b4f90e8305d7c3128026d4258d06
    build-commands:
      - mkdir -p $FLATPAK_DEST/ant
      - tar xf apache-ant-bin.tar.gz --strip-components=1 --directory=$FLATPAK_DEST/ant
      - ln -s $FLATPAK_DEST/ant/bin/ant $FLATPAK_DEST/bin

  - name: Scilab
    buildsystem: simple
    build-commands:
      #- rm ./modules/cacsd/tests/unit_tests/dscr.tst.orig
      #- sed -i '/name="Class-Path"/d' build.incl.xml
      #- sed -i '/name="Class-Path"/d' modules/javasci/build.xml
      #- sed -i '/name="Class-Path"/d' modules/scirenderer/build.xml
      - autoreconf -fvi
      #- ./configure --disable-static-system-lib --without-umfpack --without-emf --with-xcos
      - ./configure --disable-static-system-lib --with-xcos --with-jdk=/app/lib/java-8-openjdk
      - make -C modules/scicos modelicac modelicat XML2Modelica
      - make
      #- export SCI_ALL_JAR_CLASSPATHS=`grep -Eo "\".*.jar" etc/classpath.xml | sed 's/$SCILAB/$SCI/' | tr -d "\"" | tr "\n" ":"`
      #- sed -i "s|@SPEC_ALL_JAR_CLASSPATHS@|${SCI_ALL_JAR_CLASSPATHS}|" bin/scilab
      #- export SCI_LIB_PATH=/app/lib/scilab
      #- sed -i "s|@SPEC_SCI_LIB_PATH@|${SCI_LIB_PATH}|" bin/scilab
      #- export SCI_ALL_JAR_CLASSPATHS=`grep -Eo "\".*.jar" etc/classpath.xml | sed 's/$SCILAB/./' | tr -d "\"" | tr "\n" ":"`
      #- export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:./modules/*/.libs:./modules/.libs
      #- export _JAVA_OPTIONS="--add-modules=java.xml.bind,java.activation -Djava.awt.headless=true -Djava.class.path=${SCI_ALL_JAR_CLASSPATHS}"
      - make doc SCIVERBOSE=1
      - make install DESTDIR=/app
      #- mkdir -p /app/etc/ld.so.conf.d
      #- echo /app/lib/scilab > /app/etc/ld.so.conf.d/scilab.conf
      #- rm -rf /app/share/scilab/ACK*
      #- rm -rf /app/share/scilab/CHANGES*
      #- rm -rf /app/share/scilab/COPYING*
      #- rm -rf /app/share/scilab/README*
      #- rm -rf /app/share/scilab/RELEASE*
      #- rm -rf /app/share/scilab/Readme_Visual.txt
      #- rm -rf /app/share/scilab/license.txt
      #- rm -fr /app/share/applications/scilab-*.desktop
    sources:
      - type: archive
        url: http://www.scilab.org/download/6.1.0/scilab-6.1.0-src.tar.gz
        sha256: ae6befb0153fb823fd647f4eb36076f98fd20fed601f7dfa94d8c13e31044964
      #- type: file
        #path: org.scilab.Scilab.metainfo.xml

